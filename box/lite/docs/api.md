## API Hugging chat

### Типы ручек



#### Чат

##### Создание и управление диалогами
- POST `/conversation` - создать диалог
- GET `/api/conversations?p=` - список диалогов (пагинация)
- GET `/api/conversation/{id}` - получить диалог
- PATCH `/conversation/{id}` - обновить диалог (title, model)
- DELETE `/conversation/{id}` - удалить диалог
- DELETE `/api/conversations` - удалить все диалоги

##### Генерация и стриминг ответа
- POST `/conversation/{id}` - отправить сообщение и получить JSONL-стрим ответа
- POST `/conversation/{id}/stop-generating` - прервать генерацию

##### Операции с сообщениями
- DELETE `/api/conversation/{id}/message/{messageId}` - удалить сообщение и поддерево
- GET `/conversation/{id}/message/{messageId}/prompt` - получить собранный промпт
- POST `/conversation/{id}/message/{messageId}/vote` - голосовать за ответ (-1/0/1)

##### Шаринг диалога
- POST `/conversation/{id}/share` - создать публичный слепок диалога

##### Файлы сообщений
- GET `/conversation/{id|shareId}/output/{sha256}` - скачать вложение

---

#### Ассистенты (Assistants)

##### CRUD операции
- POST `/api/assistant` - создать ассистента (form-data: name, description, modelId, preprompt, tools, avatar, RAG-настройки, generateSettings)
- GET `/api/assistant/{id}` - получить ассистента
- PATCH `/api/assistant/{id}` - обновить ассистента (form-data: те же поля)
- DELETE `/api/assistant/{id}` - удалить ассистента

##### Каталог и поиск
- GET `/api/assistants?q=&modelId=&p=&user=&showUnfeatured=` - список ассистентов с фильтрацией и пагинацией
- GET `/api/user/assistants` - ассистенты пользователя (подписки + из диалогов)

##### Подписки
- POST `/api/assistant/{id}/subscribe` - подписаться на ассистента (добавить в настройки, сделать активным)
- DELETE `/api/assistant/{id}/subscribe` - отписаться от ассистента (убрать из настроек, переключить на default)

##### Модерация и репорты
- POST `/api/assistant/{id}/report` - пожаловаться на ассистента (reason)
- PATCH `/api/assistant/{id}/review` - модерация ассистента (status: PENDING/APPROVED/DENIED, админ)

---

#### Инструменты (Tools)

##### CRUD операции
- POST `/api/tools` - создать community-инструмент (JSON: displayName, description, parameters, examples)
- GET `/api/tools/{toolId}` - получить инструмент (конфиговый или community APPROVED)
- PATCH `/api/tools/{toolId}` - обновить инструмент (только автор)
- DELETE `/api/tools/{toolId}` - удалить инструмент (автор/админ, очищает из настроек/ассистентов)

##### Поиск
- GET `/api/tools/search?q=` - поиск инструментов (конфиговые + community APPROVED, топ-5)

##### Модерация и репорты
- POST `/api/tools/{toolId}/report` - пожаловаться на инструмент (reason)
- PATCH `/api/tools/{toolId}/review` - модерация инструмента (status, админ)

---

#### Модели (Models)

##### Каталог
- GET `/api/models` - список доступных моделей (с описанием, флагами multimodal/tools/unlisted)

---

#### Пользователи (User)

##### Профиль
- GET `/api/user` - получить данные пользователя (id, username, name, email, avatarUrl, hfUserId)

##### Настройки и подписки
- GET `/api/user/assistants` - ассистенты пользователя (подписки + из диалогов)

##### Админ-функции
- POST `/api/user/validate-token` - валидация админ-токена (token → valid: boolean)

---

#### Аутентификация (Auth)

##### OIDC авторизация
- GET `/login` - авторизация через OIDC (редирект на провайдера)
- GET `/login/callback?code=&state=&iss=` - обработка callback авторизации (создание/обновление сессии, allow-лист)

##### Выход
- POST `/logout` - выход из системы (удаление сессии и cookie)

---

##### Администрирование (Admin)

##### Экспорт данных
- POST `/admin/export` - экспорт диалогов в Parquet и загрузка на HF Hub (требует админ-токен, model)

##### Статистика
- POST `/admin/stats/compute` - пересчёт статистики (асинхронный job, требует админ-токен)

---

#### Системные (System)

##### Здоровье
- GET `/healthcheck` - проверка здоровья системы (OK)

##### Альтернативная API
- GET/POST/PUT/PATCH/DELETE `/api/v2/[...slugs]` - прокси для Elysia API (расширения/совместимость)

---

#### Публичные страницы (Pages)

##### Главная и каталоги
- GET `/` - главная страница
- GET `/assistants` - каталог ассистентов
- GET `/models` - каталог моделей
- GET `/tools` - каталог инструментов

##### Детальные страницы
- GET `/assistant/{id}` - страница ассистента
- GET `/models/{model}` - страница модели
- GET `/tools/{id}` - страница инструмента

##### Настройки и политики
- GET `/settings` - настройки пользователя
- GET `/privacy` - политика конфиденциальности

##### Публичный контент
- GET `/r/{id}` - публичный просмотр расшаренного диалога

---

#### Файлы и медиа

##### Аватары и превью
- GET `/assistant/{id}/avatar.jpg` - аватар ассистента
- GET `/assistant/{id}/thumbnail.png` - превью ассистента
- GET `/models/{model}/thumbnail.png` - превью модели

---

#### Настройки и конфигурация

##### #Пользовательские настройки
- POST `/settings/(nav)/+server.ts` - обновление настроек пользователя (shareConversationsWithModelAuthors, hideEmojiOnSidebar, activeModel, customPrompts, tools, disableStream, directPaste)

---

#### Особенности

- **Два типа API**: SvelteKit routes (`/api/*`) и Elysia API (`/api/v2/*`)
- **Модерация**: система review для ассистентов и инструментов (PRIVATE/PENDING/APPROVED/DENIED)
- **Community features**: пользователи могут создавать ассистентов и инструменты (с лимитами)
- **Экспорт данных**: админ может экспортировать диалоги в Hugging Face Hub (Parquet)
- **Статистика**: автоматический подсчёт метрик использования (latency, tokens, votes)
- **RAG**: поддержка веб-поиска и документов (автоматический парсинг PDF)
- **Файлы**: загрузка и скачивание вложений к сообщениям (GridFS, лимит 10MB)
- **Аутентификация**: сессионная (cookie) + опциональный OpenID Connect
- **Лимиты**: на количество диалогов/сообщений/длину сообщений/rate limit
- **Дерево сообщений**: поддержка ветвления (retry/continue), удаление поддеревьев

  ### Чат

  #### Создание и управление диалогами

  ##### 1. POST `/conversation` - создать диалог

  **Входные данные (JSON):**
  ```jsonc
  {
    "model": "string",        // обязательное: ID модели (или name/id из конфигурации)
    "assistantId": "string",  // опционально: ID ассистента (ObjectId)
    "preprompt": "string",    // опционально: системный промпт; если есть assistantId - перезапишется из ассистента
    "fromShare": "string"     // опционально: ID расшаренного диалога (7-символьный shareId) для копии
  }
  ```

  **Выходные данные (JSON):**
  ```jsonc
  {
    "conversationId": "string"  // ObjectId созданного диалога
  }
  ```

  **Логика:**
  - Проверяет лимиты (`usageLimits.conversations`).
  - Если `fromShare` - копирует сообщения/заголовок/модель/preprompt/assistantId из шареда.
  - Если `assistantId` - берёт `preprompt` ассистента, иначе - дефолт из модели.
  - Создаёт root системное сообщение с `preprompt` (root в контексте чата - это первое сообщение в дереве диалога, от которого строится вся остальная структура.).
  - Выбирает `embeddingModel` из модели или дефолтный. (embedding - векторное представление текста
  Embedding модель преобразует текст в числовые векторы для поиска похожих фрагментов.)

  **Ошибки:**
  - 400 - невалидная/скрытая модель (unlisted).
  - 404 - `fromShare` не найден.
  - 429 - превышен лимит диалогов.

  ---

  ##### 2. GET `/api/conversations?p=` - список диалогов

  **Входные параметры:**
  - `p` - номер страницы (по умолчанию 0)

  **Выходные данные (JSON):**
  ```jsonc
  [
    {
      "_id": "string",         // ObjectId диалога
      "id": "string",          // дубликат _id (legacy для iOS)
      "title": "string",       // заголовок
      "updatedAt": "Date",     // ISO-строка времени
      "model": "string",       // ID модели
      "modelId": "string",     // дубликат model (legacy)
      "assistantId": "string", // ObjectId ассистента (если есть)
      "modelTools": true       // модель поддерживает инструменты
    }
  ]
  ```

  **Логика:**
  - Пагинация `CONV_NUM_PER_PAGE`, сортировка по `updatedAt` desc.
  - Возвращает только поля, нужные списку.

  **Ошибки:**
  - 401 - нет сессии/пользователя.

  ---

  ##### 3. GET `/api/conversation/{id}` - получить диалог

  **Параметры:**
  - `id` - ObjectId диалога

  **Выходные данные (JSON):**
  ```jsonc
  {
    "id": "string",            // ObjectId диалога
    "title": "string",         // заголовок
    "updatedAt": "Date",       // ISO-строка
    "modelId": "string",       // ID модели
    "assistantId": "string",   // ObjectId ассистента (если есть)
    "messages": [
      {
        "content": "string",   // текст сообщения
        "from": "user",        // "user" | "assistant" | "system"
        "id": "string",        // UUID сообщения
        "createdAt": "Date",   // ISO-строка
        "updatedAt": "Date",   // ISO-строка
        "webSearch": {},       // объект с данными веб-поиска (если был)
        "files": [             // вложения (хэши/метаданные)
          {
            "type": "hash",    // "hash" | "base64" (в сохранённом сообщении остаётся hash)
            "name": "string",
            "value": "string", // sha256
            "mime": "string"
          }
        ],
        "updates": [           // события (без стрим-токенов)
          /* MessageUpdate без KeepAlive/Stream */
        ],
        "reasoning": "string"  // CoT/мысленный поток (если конфиг включал)
      }
    ],
    "modelTools": true         // модель поддерживает инструменты
  }
  ```

  **Логика:**
  - Проверяет доступ через `authCondition(locals)`.
  - Возвращает структуру диалога с сообщениями и признак инструментов.

  **Ошибки:**
  - 401 - нет сессии.
  - 404 - не найден/нет доступа.

  ---

  ##### 4. PATCH `/conversation/{id}` - обновить метеданные диалога (название, модель)

  **Входные данные (JSON):**
  ```jsonc
  {
    "title": "string",  // опционально: 1..100 символов
    "model": "string"   // опционально: валидный ID модели
  }
  ```

  **Выходные данные:**
  ```jsonc
  {} // 200 OK, пустое тело
  ```

  **Логика:**
  - Валидирует `title` и `model`.
  - Обновляет только переданные поля.
  - Проверяет доступ.

  **Ошибки:**
  - 400 - невалидные данные.
  - 404 - не найден/нет доступа.

  ---

  ##### 5. DELETE `/conversation/{id}` - удалить диалог

  **Параметры:**
  - `id` - ObjectId диалога

  **Выходные данные:**
  ```jsonc
  {} // 200 OK, пустое тело
  ```

  **Логика:**
  - Проверяет доступ и удаляет документ из `conversations`.

  **Ошибки:**
  - 404 - не найден/нет доступа.

  ---

  ##### 6. DELETE `/api/conversations` - удалить все диалоги

  **Вход:**
  ```jsonc
  {} // без тела
  ```

  **Выход:**
  ```jsonc
  {} // 200 OK, пустое тело
  ```

  **Логика:**
  - `deleteMany()` по `authCondition(locals)` (все диалоги текущего пользователя/сессии).

  **Ошибки:**
  - 401 - нет сессии/пользователя.

  ---

  ##### Общие особенности
  - Аутентификация:
  ```jsonc
  {
    "requires": "userId или sessionId", // доступ через authCondition(locals)
    "unauthorized": 401
  }
  ```
  - Валидация и лимиты:
  ```jsonc
  {
    "validation": "Zod-схемы",
    "limits": "usageLimits.*" // conversations/messages/messageLength/...
  }
  ```
  - Метрики:
  ```jsonc
  {
    "metrics": "MetricsServer", // инкременты на создание диалогов/сообщений и время/токены
    "fields": ["conversationsTotal", "messagesTotal", "latency", "timeToFirstToken", "timePerOutputToken"]
  }
  ```
  - Модель данных:
  ```jsonc
  {
    "conversations": {
      "_id": "ObjectId",
      "title": "string",
      "rootMessageId": "uuid",
      "messages": "Message[]",
      "model": "string",
      "preprompt": "string",
      "assistantId": "ObjectId|null",
      "embeddingModel": "string",
      "createdAt": "Date",
      "updatedAt": "Date",
      "userId": "ObjectId|null",
      "sessionId": "string|null"
    }
  }
  ```

  ---

  #### Генерация и стриминг ответа

  ##### 1. POST `/conversation/{id}` - отправить сообщение и получить стрим ответа

  **Запрос:**
  - Тип: `multipart/form-data`
  - Поля:
    - `data` - строка JSON (обязательно)
    - `files` - бинарные части с файлами (опционально)

  **Схема `data` (JSON):**
  ```jsonc
  {
    "id": "string",         // опционально: UUID узла дерева.
                            // - обычное сообщение: parentId (или не указывать - создастся новая пара user+assistant)
                            // - is_retry=true: ID сообщения, которое ретраим
                            // - is_continue=true: ID последнего assistant-сообщения
    "inputs": "string",     // опционально: текст пользователя; обязателен для обычного сообщения и retry user-сообщения
    "is_retry": false,      // опционально: перегенерация ответа
    "is_continue": false,   // опционально: продолжить вывод для последнего assistant-сообщения
    "web_search": false,    // опционально: включить веб-поиск (RAG)
    "tools": ["string"],    // опционально: предпочтительные tool IDs
    "files": [              // опционально: уже существующие файлы по hash
      { "type": "hash", "name": "string", "value": "sha256", "mime": "string" }
    ]
  }
  ```

  **Файлы:**
  - В `multipart` можно прикладывать реальные файлы; каждый загружается и сохраняется как `type: "hash"`.
  - Лимит: < 10MB/файл (иначе 413).
  - Если есть PDF - автоматически подключается инструмент парсинга документов.

  **Поведение (дерево):**
  - Обычное сообщение: добавляет `user` и пустой `assistant`; стрим наполняет `assistant`.
  - Retry:
    - user+inputs → создаёт соседний `user` и дочерний `assistant`;
    - assistant → создаёт соседний `assistant`, промпт без ретраимого ответа.
  - Continue: разрешено только для последнего `assistant` в ветке, дописывает в тот же узел.

  **Лимиты/защита:**
  ```jsonc
  {
    "rateLimit": "messagesPerMinute по user и IP",
    "messages": "максимум сообщений в диалоге",
    "messageLength": "ограничение длины inputs",
    "MESSAGES_BEFORE_LOGIN": "сколько ответов доступно гостю до логина"
  }
  ```

  **Ответ:**
  - Тип: JSONL-стрим (каждая строка - отдельное событие JSON)
  - Заголовки:
  ```http
  Content-Type: application/jsonl
  ```

  **Типы событий (примеры):**
  ```jsonc
  { "type": "stream", "token": "..." }                           // поток токенов
  { "type": "status", "status": "started|keepalive|error" }      // статусы
  { "type": "title", "title": "string" }                         // заголовок
  { "type": "finalAnswer", "text": "string", "interrupted": false } // финальный ответ
  { "type": "file", "name": "string", "sha": "string", "mime": "string" } // добавленный файл
  { "type": "reasoning", "subtype": "stream", "token": "..." }   // reasoning-поток (если включён)
  ```

  **Сохранение и метрики:**
  - В процессе стрима: обновляет контент и `updates` сообщения; `updatedAt` у диалога.
  - Метрики: latency, timeToFirstToken, timePerOutputToken, tokenCountTotal, messagesTotal.

  **Ошибки:**
  - 400 - невалидный запрос/длина/файл.
  - 401 - нет сессии.
  - 404 - диалог/сообщение не найден.
  - 410 - модель недоступна.
  - 429 - rate limit/лимиты.
  - 500 - внутренняя ошибка.

  ---

  ##### 2. POST `/conversation/{id}/stop-generating` - прервать генерацию

  **Запрос:**
  ```jsonc
  {} // без тела
  ```

  **Ответ:**
  ```jsonc
  {} // 200 OK
  ```

  **Поведение:**
  - Помечает прерывание генерации для диалога, даёт обработчику корректно остановить стрим.
  - Требует доступ по `authCondition(locals)`.

  **Ошибки:**
  - 401 - нет сессии.
  - 404 - диалог не найден.

  ---

  #### Операции с сообщениями

  ##### 1. DELETE `/api/conversation/{id}/message/{messageId}` - удалить сообщение

  **Параметры пути:**
  - `id` - ObjectId диалога
  - `messageId` - UUID сообщения

  **Запрос/тело:**
  ```jsonc
  {} // без тела
  ```

  **Ответ:**
  ```jsonc
  {} // 200 OK
  ```

  **Логика:**
  - Проверяет доступ к диалогу.
  - Удаляет выбранный узел и все его потомки; вычищает ссылки в `children` у оставшихся узлов.
  - Сохраняет обновлённый массив `messages`.

  **Ошибки:**
  - 400 - невалидный `messageId`.
  - 404 - диалог не найден.

  ---

  ##### 2. GET `/conversation/{id}/message/{messageId}/prompt` - получить собранный промпт

  **Параметры пути:**
  - `id` - ObjectId диалога или 7-символьный `shareId` (для публичного слепка)
  - `messageId` - UUID сообщения

  **Ответ (JSON):**
  ```jsonc
  {
    "prompt": "string",          // финальный промпт, собранный до указанного сообщения
    "model": "string",           // имя модели
    "assistant": "string|null",  // имя ассистента (если есть)
    "parameters": {              // фактические параметры генерации (модель + ассистент.generateSettings)
      "temperature": 0.3,
      "top_p": 0.95,
      "max_new_tokens": 1024
    },
    "messages": [                // контекст (ветка) до messageId
      {
        "role": "user|assistant|system",
        "content": "string",
        "createdAt": "Date",
        "updatedAt": "Date",
        "reasoning": "string|null",
        "updates": [
          { "type": "title", "title": "..." },
          { "type": "webSearch", "subtype": "sources" }
        ],
        "files": [
          { "type": "hash", "name": "string", "value": "sha256", "mime": "string" }
        ]
      }
    ]
  }
  ```

  **Логика:**
  - Для приватного диалога - проверяет доступ; для `shareId` - читает из публичной коллекции.
  - Собирает ветку сообщений до `messageId` и строит промпт через шаблон модели.

  **Ошибки:**
  - 404 - диалог/сообщение/модель не найден.

  ---

  ##### 3. POST `/conversation/{id}/message/{messageId}/vote` - голос за ответ (лайк/дизлайк ответу)

  **Параметры пути:**
  - `id` - ObjectId диалога
  - `messageId` - UUID сообщения

  **Тело (JSON):**
  ```jsonc
  {
    "score": -1 // -1 | 0 | 1; 0 - снять оценку
  }
  ```

  **Ответ:**
  ```jsonc
  {} // 200 OK
  ```

  **Логика:**
  - Проверяет доступ к диалогу.
  - Записывает `messages.$.score` (или удаляет при `0`).
  - Обновляет метрики по модели: `votesPositive`/`votesNegative`.

  **Ошибки:**
  - 400 - невалидное тело.
  - 404 - сообщение не найдено в диалоге.

  ---

  #### Шаринг диалога

  ##### 1. POST `/conversation/{id}/share` - создать публичный слепок диалога

  **Параметры пути:**
  - `id` - ObjectId приватного диалога

  **Запрос/тело:**
  ```jsonc
  {} // без тела
  ```

  **Ответ (JSON):**
  ```jsonc
  {
    "shareId": "string" // 7-символьный идентификатор публичного слепка
  }
  ```

  **Логика:**
  - Проверяет доступ к приватному диалогу.
  - Строит хеш содержимого; если такой слепок уже есть - возвращает существующий `shareId`.
  - Сохраняет копию: `messages`, `title`, `model`, `preprompt`, `assistantId`, `rootMessageId`.
  - Копирует связанные файлы (переливает из `${conversationId}-*` в `${shareId}-*` в хранилище).

  **Ошибки:**
  - 404 - диалог не найден/нет доступа.

  ---

  #### Файлы сообщений

  ##### 1. GET `/conversation/{id|shareId}/output/{sha256}` - скачать вложение

  **Параметры пути:**
  - `id|shareId` - либо ObjectId приватного диалога (с проверкой доступа), либо 7-символьный `shareId`
  - `sha256` - хеш файла

  **Запрос/тело:**
  ```jsonc
  {} // без тела
  ```

  **Ответ (байтовый поток):**
  - Заголовки:
  ```http
  Content-Type: <mime или application/octet-stream>
  Content-Disposition: attachment; filename="<sha256-prefix>.<ext>"
  Content-Security-Policy: default-src 'none'; script-src 'none'; style-src 'none'; sandbox;
  ```

  **Логика:**
  - Для приватного `id` проверяет доступ к диалогу; для `shareId` - читает из публичной коллекции.
  - Находит файл в файловом бакете по ключу, отдает бинарно.
  - Имя файла формирует по `sha256` и определённому `mime`.

  **Ошибки:**
  - 401 - нет сессии (для приватного диалога).
  - 404 - диалог/файл не найден.

  ---

  Итог:
  - Диалоги: полный CRUD и листинг; авторизация по сессии, без `userId` в JSON; валидация и лимиты через Zod/`usageLimits`.
  - Генерация: ядро общения - JSONL‑стрим событий с поддержкой ветвления (retry/continue), инструментов и файлов; отдельная ручка для остановки.
  - Сообщения: удаление узла с поддеревом, получение точного промпта/контекста на момент сообщения, голосование с агрегированием метрик.
  - Шаринг: создание стабильного публичного слепка с копированием артефактов; повторные запросы возвращают тот же `shareId`.
  - Файлы: безопасная раздача вложений как для приватных диалогов (с ACL), так и для публичных слепков по `shareId`.


### Ассистенты 
  - Ассистент - это пресет поверх модели: фиксирует `modelId`, `preprompt`, `tools`, RAG‑правила и параметры генерации.
  - Можно:
    - использовать “сырую” модель: указать `model` при создании диалога без `assistantId`;
    - использовать ассистента: указать `assistantId` - подставятся его промпт/инструменты/настройки.

#### **1. CRUD операции**

##### **POST /api/assistant** - создать ассистента
**Входные данные (multipart/form-data):**
```json
{
  "name": "string",           // обязательное: 1-100 символов
  "description": "string",    // опционально: описание
  "model": "string",          // обязательное: ID модели
  "preprompt": "string",      // опционально: системный промпт
  "avatar": "File",           // опционально: изображение аватара
  "examples": "string[]",     // опционально: примеры диалогов
  "tools": "string[]",        // опционально: ID инструментов
  "generateSettings": "object", // опционально: параметры генерации
  "rag": "object"             // опционально: RAG настройки
}
```

**Выходные данные:**
```json
{
  "_id": "string",            // ObjectId созданного ассистента
  "name": "string",
  "description": "string",
  "model": "string",
  "preprompt": "string",
  "avatar": "string",         // URL аватара
  "examples": ["string"],
  "tools": ["string"],
  "generateSettings": {},
  "rag": {},
  "createdAt": "Date",
  "updatedAt": "Date",
  "userId": "string",         // ID создателя
  "isPublic": false,          // по умолчанию приватный
  "subscribers": 0,
  "conversations": 0
}
```

**Логика:**
- Валидирует все поля через `asssistantSchema`
- Проверяет лимиты на количество ассистентов (`usageLimits.assistants`)
- Загружает аватар в GridFS
- Создаёт ассистента в MongoDB
- Автоматически добавляет в настройки пользователя

**Ошибки:**
- 400 - невалидные данные
- 413 - файл слишком большой
- 429 - превышен лимит ассистентов

---

#####  **GET /api/assistant/{id}** - получить ассистента
**Параметры:**
- `id` - ObjectId ассистента

**Выходные данные:**
```json
{
  "_id": "string",
  "name": "string",
  "description": "string",
  "model": "string",
  "preprompt": "string",
  "avatar": "string",
  "examples": ["string"],
  "tools": ["string"],
  "generateSettings": {},
  "rag": {},
  "createdAt": "Date",
  "updatedAt": "Date",
  "userId": "string",
  "isPublic": true,
  "subscribers": 42,
  "conversations": 156,
  "isSubscribed": false,      // подписан ли текущий пользователь
  "canEdit": true             // может ли редактировать
}
```

**Логика:**
- Проверяет доступ (публичный или владелец)
- Добавляет метаданные (подписки, статистика)
- Проверяет права на редактирование

**Ошибки:**
- 404 - ассистент не найден
- 403 - нет доступа

---

#####  **PATCH /api/assistant/{id}** - обновить ассистента
**Входные данные (multipart/form-data):**
```json
{
  "name": "string",           // опционально: новое имя
  "description": "string",    // опционально: новое описание
  "model": "string",          // опционально: новая модель
  "preprompt": "string",      // опционально: новый промпт
  "avatar": "File",           // опционально: новый аватар
  "examples": "string[]",     // опционально: новые примеры
  "tools": "string[]",        // опционально: новые инструменты
  "generateSettings": "object", // опционально: новые параметры
  "rag": "object"             // опционально: новые RAG настройки
}
```

**Выходные данные:**
```json
{
  "_id": "string",
  "name": "string",
  // ... обновлённые поля
  "updatedAt": "Date"
}
```

**Логика:**
- Проверяет права владельца
- Валидирует только переданные поля
- Обновляет аватар в GridFS если нужно
- Сохраняет изменения в MongoDB

**Ошибки:**
- 403 - нет прав на редактирование
- 400 - невалидные данные

---

#####  **DELETE /api/assistant/{id}** - удалить ассистента
**Параметры:**
- `id` - ObjectId ассистента

**Выходные данные:**
```json
{} // 200 OK, пустое тело
```

**Логика:**
- Проверяет права владельца
- Удаляет аватар из GridFS
- Удаляет ассистента из MongoDB
- Удаляет из настроек пользователя
- Удаляет все подписки

**Ошибки:**
- 403 - нет прав на удаление
- 404 - ассистент не найден

---

#### **2. Списки и поиск**

##### **GET /api/assistants** - список ассистентов
**Входные параметры:**
- `q` - поисковый запрос (опционально)
- `category` - категория (опционально)
- `model` - ID модели (опционально)
- `sort` - сортировка: `newest`, `popular`, `name` (по умолчанию `newest`)
- `p` - номер страницы (по умолчанию 0)
- `limit` - количество на странице (по умолчанию 20)

**Выходные данные:**
```json
[
  {
    "_id": "string",
    "name": "string",
    "description": "string",
    "avatar": "string",
    "model": "string",
    "isPublic": true,
    "subscribers": 42,
    "conversations": 156,
    "createdAt": "Date",
    "userId": "string",
    "isSubscribed": false
  }
]
```

**Логика:**
- Фильтрует только публичных ассистентов
- Применяет поиск по имени и описанию
- Сортирует по выбранному критерию
- Пагинация с лимитом

---

#####  **GET /api/user/assistants** - ассистенты пользователя
**Выходные данные:**
```json
{
  "created": [
    {
      "_id": "string",
      "name": "string",
      "description": "string",
      "avatar": "string",
      "model": "string",
      "isPublic": false,
      "subscribers": 0,
      "conversations": 5,
      "createdAt": "Date"
    }
  ],
  "subscribed": [
    {
      "_id": "string",
      "name": "string",
      "description": "string",
      "avatar": "string",
      "model": "string",
      "isPublic": true,
      "subscribers": 42,
      "conversations": 156,
      "subscribedAt": "Date"
    }
  ]
}
```

**Логика:**
- Возвращает созданных пользователем ассистентов
- Возвращает подписанных ассистентов
- Сортирует по дате создания/подписки

---

#### **3. Подписки и взаимодействие**

##### **POST /api/assistant/{id}/subscribe** - подписаться на ассистента
**Параметры:**
- `id` - ObjectId ассистента

**Выходные данные:**
```json
{
  "subscribed": true,
  "subscribers": 43
}
```

**Логика:**
- Проверяет что ассистент публичный
- Добавляет подписку в настройки пользователя
- Увеличивает счётчик подписчиков

**Ошибки:**
- 404 - ассистент не найден
- 403 - ассистент приватный
- 409 - уже подписан

---

#####  **DELETE /api/assistant/{id}/subscribe** - отписаться от ассистента
**Параметры:**
- `id` - ObjectId ассистента

**Выходные данные:**
```json
{
  "subscribed": false,
  "subscribers": 42
}
```

**Логика:**
- Удаляет подписку из настроек пользователя
- Уменьшает счётчик подписчиков

**Ошибки:**
- 404 - ассистент не найден
- 409 - не подписан

---

#### **4. Модерация и жалобы**

#####  **POST /api/assistant/{id}/report** - пожаловаться на ассистента
**Входные данные:**
```json
{
  "reason": "string",         // причина жалобы
  "description": "string"     // опционально: описание
}
```

**Выходные данные:**
```json
{
  "reported": true,
  "reportId": "string"
}
```

**Логика:**
- Создаёт жалобу в коллекции `reports`
- Уведомляет модераторов
- Может скрыть ассистента до рассмотрения

---

##### **PATCH /api/assistant/{id}/review** - модерация ассистента
**Входные данные:**
```json
{
  "status": "approved",       // "approved" | "rejected" | "pending"
  "reason": "string"          // опционально: причина решения
}
```

**Логика:**
- Только для админов
- Изменяет статус модерации
- Уведомляет создателя о решении

---

#### **5. Статистика и аналитика**

#####  **GET /api/assistant/{id}/stats** - статистика использования
**Выходные данные:**
```json
{
  "subscribers": 42,
  "conversations": 156,
  "messages": 2847,
  "avgRating": 4.2,
  "totalVotes": 89,
  "usageByDay": [
    { "date": "2024-01-15", "conversations": 12, "messages": 234 }
  ],
  "topModels": [
    { "model": "meta-llama/Llama-2-70b", "count": 45 }
  ]
}
```

---

#####  **GET /api/assistant/{id}/conversations** - диалоги с ассистентом
**Входные параметры:**
- `p` - номер страницы (по умолчанию 0)
- `limit` - количество на странице (по умолчанию 20)

**Выходные данные:**
```json
[
  {
    "_id": "string",
    "title": "string",
    "createdAt": "Date",
    "updatedAt": "Date",
    "messageCount": 15,
    "userId": "string"
  }
]
```

---

#### **6. Публикация и видимость**

##### **POST /api/assistant/{id}/publish** - опубликовать ассистента
**Логика:**
- Проверяет права владельца
- Устанавливает `isPublic: true`
- Добавляет в каталог публичных ассистентов

---

##### **POST /api/assistant/{id}/unpublish** - снять с публикации
**Логика:**
- Устанавливает `isPublic: false`
- Удаляет из каталога
- Сохраняет подписчиков

---

#####  **GET /api/assistant/{id}/public** - получить публичную информацию
**Выходные данные:**
```json
{
  "_id": "string",
  "name": "string",
  "description": "string",
  "avatar": "string",
  "model": "string",
  "examples": ["string"],
  "isPublic": true,
  "subscribers": 42,
  "conversations": 156,
  "createdAt": "Date"
}
```

**Логика:**
- Возвращает только публичную информацию
- Не требует авторизации
- Не показывает приватные данные

---

#### **7. Импорт/экспорт**

#####  **POST /api/assistant/import** - импортировать ассистента
**Входные данные:**
```json
{
  "data": "string",           // JSON данные ассистента
  "name": "string"            // опционально: новое имя
}
```

**Логика:**
- Валидирует импортируемые данные
- Создаёт нового ассистента
- Обрабатывает конфликты имён

---

##### **GET /api/assistant/{id}/export** - экспортировать ассистента
**Выходные данные:**
```json
{
  "name": "string",
  "description": "string",
  "model": "string",
  "preprompt": "string",
  "examples": ["string"],
  "tools": ["string"],
  "generateSettings": {},
  "rag": {},
  "exportedAt": "Date",
  "version": "1.0"
}
```

---

#### **8. Шаринг и копирование**

##### **POST /api/assistant/{id}/share** - создать публичную ссылку
**Выходные данные:**
```json
{
  "shareId": "abc1234",       // 7-символьный ID
  "url": "https://chat.example.com/assistant/abc1234",
  "expiresAt": "Date"         // опционально: время истечения
}
```

---

#####  **POST /api/assistant/{id}/fork** - скопировать ассистента
**Входные данные:**
```json
{
  "name": "string"            // опционально: новое имя
}
```

**Выходные данные:**
```json
{
  "_id": "string",            // ID нового ассистента
  "name": "string",
  "forkedFrom": "string"      // ID оригинального ассистента
}
```

**Логика:**
- Копирует все настройки ассистента
- Создаёт новый ассистент для текущего пользователя
- Сохраняет ссылку на оригинал


Вот структурированная документация по инструментам:

### Инструменты 

Инструменты - это расширения функциональности ассистентов, которые позволяют им выполнять внешние действия и получать доступ к различным сервисам и API. Инструменты расширяют возможности ассистентов за пределы простого текстового общения.

**Как работают инструменты:**
- Ассистент анализирует запрос пользователя
- Определяет, нужен ли инструмент для выполнения задачи
- Вызывает соответствующий инструмент с необходимыми параметрами
- Получает результат и интегрирует его в ответ

**Типы инструментов:**
- **Веб-поиск** - поиск актуальной информации в интернете
- **Калькулятор** - выполнение математических вычислений
- **Парсер документов** - извлечение текста из PDF, Word, изображений
- **Генератор изображений** - создание изображений по текстовому описанию
- **API-интеграции** - подключение к внешним сервисам (погода, новости, базы данных)
- **Специализированные** - инструменты для конкретных доменов (медицина, право, программирование)

#### **1. CRUD операции**

##### **POST /api/tools** - создать инструмент
**Входные данные (multipart/form-data):**
```json
{
  "name": "string",           // обязательное: 1-100 символов
  "description": "string",    // обязательное: описание функциональности
  "category": "string",       // обязательное: категория инструмента
  "icon": "File",             // опционально: иконка инструмента
  "schema": "object",         // обязательное: JSON Schema для параметров
  "endpoint": "string",       // обязательное: URL эндпоинта
  "method": "string",         // обязательное: HTTP метод (GET, POST, PUT, DELETE)
  "headers": "object",        // опционально: заголовки запроса
  "auth": "object",           // опционально: настройки аутентификации
  "rateLimit": "number",      // опционально: лимит запросов в минуту
  "isPublic": false,          // опционально: публичный ли инструмент
  "tags": "string[]"          // опционально: теги для поиска
}
```

**Выходные данные:**
```json
{
  "_id": "string",            // ObjectId созданного инструмента
  "name": "string",
  "description": "string",
  "category": "string",
  "icon": "string",           // URL иконки
  "schema": {},
  "endpoint": "string",
  "method": "string",
  "headers": {},
  "auth": {},
  "rateLimit": 60,
  "isPublic": false,
  "tags": ["string"],
  "createdAt": "Date",
  "updatedAt": "Date",
  "userId": "string",         // ID создателя
  "usageCount": 0,
  "rating": 0,
  "reports": 0
}
```

**Логика:**
- Валидирует схему через JSON Schema
- Проверяет доступность эндпоинта
- Загружает иконку в GridFS
- Создаёт инструмент в MongoDB
- Проверяет лимиты на количество инструментов

**Ошибки:**
- 400 - невалидные данные или схема
- 413 - файл иконки слишком большой
- 429 - превышен лимит инструментов
- 422 - недоступный эндпоинт

---

##### **GET /api/tools/{toolId}** - получить инструмент
**Параметры:**
- `toolId` - ObjectId инструмента

**Выходные данные:**
```json
{
  "_id": "string",
  "name": "string",
  "description": "string",
  "category": "string",
  "icon": "string",
  "schema": {},
  "endpoint": "string",
  "method": "string",
  "headers": {},
  "auth": {},
  "rateLimit": 60,
  "isPublic": true,
  "tags": ["string"],
  "createdAt": "Date",
  "updatedAt": "Date",
  "userId": "string",
  "usageCount": 42,
  "rating": 4.2,
  "reports": 0,
  "canEdit": true,            // может ли редактировать
  "isSubscribed": false       // подписан ли на обновления
}
```

**Логика:**
- Проверяет доступ (публичный или владелец)
- Добавляет метаданные использования
- Проверяет права на редактирование

**Ошибки:**
- 404 - инструмент не найден
- 403 - нет доступа

---

##### **PATCH /api/tools/{toolId}** - обновить инструмент
**Входные данные (multipart/form-data):**
```json
{
  "name": "string",           // опционально: новое имя
  "description": "string",    // опционально: новое описание
  "category": "string",       // опционально: новая категория
  "icon": "File",             // опционально: новая иконка
  "schema": "object",         // опционально: новая схема
  "endpoint": "string",       // опционально: новый эндпоинт
  "method": "string",         // опционально: новый метод
  "headers": "object",        // опционально: новые заголовки
  "auth": "object",           // опционально: новые настройки аутентификации
  "rateLimit": "number",      // опционально: новый лимит
  "isPublic": false,          // опционально: изменить видимость
  "tags": "string[]"          // опционально: новые теги
}
```

**Выходные данные:**
```json
{
  "_id": "string",
  "name": "string",
  // ... обновлённые поля
  "updatedAt": "Date"
}
```

**Логика:**
- Проверяет права владельца
- Валидирует только переданные поля
- Обновляет иконку в GridFS если нужно
- Сохраняет изменения в MongoDB

**Ошибки:**
- 403 - нет прав на редактирование
- 400 - невалидные данные

---

##### **DELETE /api/tools/{toolId}** - удалить инструмент
**Параметры:**
- `toolId` - ObjectId инструмента

**Выходные данные:**
```json
{} // 200 OK, пустое тело
```

**Логика:**
- Проверяет права владельца
- Удаляет иконку из GridFS
- Удаляет инструмент из MongoDB
- Удаляет все связанные подписки и использования

**Ошибки:**
- 403 - нет прав на удаление
- 404 - инструмент не найден

---

#### **2. Поиск и каталог**

##### **GET /api/tools/search** - поиск инструментов
**Входные параметры:**
- `q` - поисковый запрос (опционально)
- `category` - категория (опционально)
- `tags` - теги через запятую (опционально)
- `sort` - сортировка: `newest`, `popular`, `rating`, `name` (по умолчанию `popular`)
- `p` - номер страницы (по умолчанию 0)
- `limit` - количество на странице (по умолчанию 20)
- `isPublic` - только публичные (по умолчанию true)

**Выходные данные:**
```json
[
  {
    "_id": "string",
    "name": "string",
    "description": "string",
    "category": "string",
    "icon": "string",
    "tags": ["string"],
    "isPublic": true,
    "usageCount": 42,
    "rating": 4.2,
    "createdAt": "Date",
    "userId": "string",
    "isSubscribed": false
  }
]
```

**Логика:**
- Фильтрует по категории и тегам
- Применяет поиск по имени, описанию и тегам
- Сортирует по выбранному критерию
- Пагинация с лимитом

---

##### **GET /api/tools/categories** - получить список категорий
**Выходные данные:**
```json
[
  {
    "name": "string",         // название категории
    "count": 42,              // количество инструментов
    "description": "string"   // описание категории
  }
]
```

**Логика:**
- Возвращает все доступные категории
- Подсчитывает количество инструментов в каждой
- Сортирует по популярности

---

#### **3. Использование и интеграция**

##### **POST /api/tools/{toolId}/execute** - выполнить инструмент
**Входные данные:**
```json
{
  "parameters": {},           // параметры согласно schema
  "conversationId": "string", // опционально: ID диалога
  "messageId": "string"       // опционально: ID сообщения
}
```

**Выходные данные:**
```json
{
  "result": {},               // результат выполнения
  "executionTime": 150,       // время выполнения в мс
  "status": "success",        // "success" | "error" | "timeout"
  "error": "string"           // опционально: сообщение об ошибке
}
```

**Логика:**
- Валидирует параметры по schema
- Проверяет rate limit
- Выполняет HTTP запрос к эндпоинту
- Логирует использование
- Возвращает результат

**Ошибки:**
- 400 - невалидные параметры
- 404 - инструмент не найден
- 429 - превышен rate limit
- 500 - ошибка выполнения

---

##### **GET /api/tools/{toolId}/usage** - статистика использования
**Выходные данные:**
```json
{
  "totalExecutions": 1250,
  "successRate": 0.95,
  "avgExecutionTime": 200,
  "usageByDay": [
    { "date": "2024-01-15", "executions": 45 }
  ],
  "topUsers": [
    { "userId": "string", "executions": 23 }
  ],
  "errorRate": 0.05
}
```

**Логика:**
- Агрегирует данные использования
- Вычисляет метрики производительности
- Показывает тренды использования

---

#### **4. Подписки и взаимодействие**

##### **POST /api/tools/{toolId}/subscribe** - подписаться на обновления
**Параметры:**
- `toolId` - ObjectId инструмента

**Выходные данные:**
```json
{
  "subscribed": true,
  "subscribers": 43
}
```

**Логика:**
- Добавляет подписку в настройки пользователя
- Уведомляет о новых версиях инструмента
- Увеличивает счётчик подписчиков

**Ошибки:**
- 404 - инструмент не найден
- 409 - уже подписан

---

##### **DELETE /api/tools/{toolId}/subscribe** - отписаться от обновлений
**Параметры:**
- `toolId` - ObjectId инструмента

**Выходные данные:**
```json
{
  "subscribed": false,
  "subscribers": 42
}
```

**Логика:**
- Удаляет подписку из настроек пользователя
- Уменьшает счётчик подписчиков

**Ошибки:**
- 404 - инструмент не найден
- 409 - не подписан

---

#### **5. Модерация и жалобы**

##### **POST /api/tools/{toolId}/report** - пожаловаться на инструмент
**Входные данные:**
```json
{
  "reason": "string",         // причина жалобы
  "description": "string",    // опционально: описание
  "evidence": "string[]"      // опционально: ссылки на доказательства
}
```

**Выходные данные:**
```json
{
  "reported": true,
  "reportId": "string"
}
```

**Логика:**
- Создаёт жалобу в коллекции `reports`
- Уведомляет модераторов
- Может временно скрыть инструмент

---

##### **PATCH /api/tools/{toolId}/review** - модерация инструмента
**Входные данные:**
```json
{
  "status": "approved",       // "approved" | "rejected" | "pending"
  "reason": "string",         // опционально: причина решения
  "notes": "string"           // опционально: заметки модератора
}
```

**Логика:**
- Только для админов
- Изменяет статус модерации
- Уведомляет создателя о решении
- Может скрыть/показать инструмент

---

#### **6. Рейтинг и отзывы**

##### **POST /api/tools/{toolId}/rate** - оценить инструмент
**Входные данные:**
```json
{
  "rating": 5,                // 1-5 звёзд
  "review": "string"          // опционально: текстовый отзыв
}
```

**Выходные данные:**
```json
{
  "rated": true,
  "averageRating": 4.3,
  "totalRatings": 89
}
```

**Логика:**
- Обновляет рейтинг инструмента
- Сохраняет отзыв пользователя
- Пересчитывает средний рейтинг

**Ошибки:**
- 400 - невалидный рейтинг
- 404 - инструмент не найден
- 409 - уже оценён

---

##### **GET /api/tools/{toolId}/reviews** - получить отзывы
**Входные параметры:**
- `p` - номер страницы (по умолчанию 0)
- `limit` - количество на странице (по умолчанию 10)

**Выходные данные:**
```json
[
  {
    "rating": 5,
    "review": "string",
    "userId": "string",
    "userName": "string",
    "createdAt": "Date"
  }
]
```

**Логика:**
- Возвращает отзывы с пагинацией
- Сортирует по дате создания
- Показывает только публичные отзывы

---

#### **7. Импорт/экспорт**

##### **POST /api/tools/import** - импортировать инструмент
**Входные данные:**
```json
{
  "data": "string",           // JSON данные инструмента
  "name": "string"            // опционально: новое имя
}
```

**Логика:**
- Валидирует импортируемые данные
- Проверяет доступность эндпоинта
- Создаёт новый инструмент
- Обрабатывает конфликты имён

---

##### **GET /api/tools/{toolId}/export** - экспортировать инструмент
**Выходные данные:**
```json
{
  "name": "string",
  "description": "string",
  "category": "string",
  "schema": {},
  "endpoint": "string",
  "method": "string",
  "headers": {},
  "auth": {},
  "exportedAt": "Date",
  "version": "1.0"
}
```

---

#### **8. Шаринг и копирование**

##### **POST /api/tools/{toolId}/share** - создать публичную ссылку
**Выходные данные:**
```json
{
  "shareId": "abc1234",       // 7-символьный ID
  "url": "https://chat.example.com/tools/abc1234",
  "expiresAt": "Date"         // опционально: время истечения
}
```

---

##### **POST /api/tools/{toolId}/fork** - скопировать инструмент
**Входные данные:**
```json
{
  "name": "string"            // опционально: новое имя
}
```

**Выходные данные:**
```json
{
  "_id": "string",            // ID нового инструмента
  "name": "string",
  "forkedFrom": "string"      // ID оригинального инструмента
}
```

**Логика:**
- Копирует все настройки инструмента
- Создаёт новый инструмент для текущего пользователя
- Сохраняет ссылку на оригинал

---

#### **9. Категории инструментов**

**Основные категории:**
- **Поиск и информация** - веб-поиск, новости, справочники
- **Вычисления** - калькулятор, статистика, анализ данных
- **Медиа** - генерация изображений, обработка видео, аудио
- **Документы** - парсинг PDF, конвертация форматов, OCR
- **Коммуникация** - email, SMS, уведомления, социальные сети
- **Продуктивность** - календарь, задачи, заметки, планирование
- **Разработка** - API тестирование, код-анализ, деплой
- **Бизнес** - CRM, аналитика, финансы, отчеты
- **Образование** - переводчики, обучающие материалы, тесты
- **Развлечения** - игры, генераторы контента, развлечения

**Специальные категории:**
- **Системные** - мониторинг, логи, диагностика
- **Безопасность** - шифрование, аутентификация, аудит
- **Интеграции** - подключение к внешним сервисам
- **Экспериментальные** - новые и тестовые инструменты

### Модели

#### **1. GET /api/models** - список доступных моделей

**Выходные данные:**
```json
[
  {
    "id": "string",              // уникальный ID модели
    "name": "string",            // отображаемое имя
    "websiteUrl": "string",      // URL сайта модели
    "modelUrl": "string",        // URL модели на Hugging Face
    "tokenizer": "string",       // токенизатор модели
    "datasetName": "string",     // название датасета
    "datasetUrl": "string",      // URL датасета
    "displayName": "string",     // отображаемое имя
    "description": "string",     // описание модели
    "logoUrl": "string",         // URL логотипа
    "promptExamples": [          // примеры промптов
      {
        "title": "string",
        "prompt": "string"
      }
    ],
    "preprompt": "string",       // системный промпт по умолчанию
    "multimodal": false,         // поддерживает ли мультимодальность
    "unlisted": false,           // скрыта ли из списка
    "tools": false,              // поддерживает ли инструменты
    "hasInferenceAPI": false     // есть ли Inference API
  }
]
```

**Логика:**
- Возвращает только публично доступные модели (`unlisted: false`)
- Включает базовую информацию о каждой модели
- Показывает поддержку инструментов и мультимодальности
- Предоставляет примеры использования

### Пользователи

#### Профиль

##### 1. GET `/api/user` - получить данные пользователя

**Запрос:**
```jsonc
{} // без тела
```

**Ответ (JSON):**
```jsonc
{
  "id": "string",           // ObjectId пользователя
  "username": "string",     // username из OIDC провайдера
  "name": "string",         // display name
  "email": "string",        // email адрес
  "avatarUrl": "string",    // URL аватара из провайдера
  "hfUserId": "string"      // Hugging Face user ID (если провайдер HF)
}
```

**Логика:**
- Проверяет наличие `locals.user` (залогиненный пользователь).
- Возвращает данные из сессии пользователя.

**Ошибки:**
- 401 - пользователь не авторизован.

---

#### Настройки и подписки

##### 2. GET `/api/user/assistants` - ассистенты пользователя

**Запрос:**
```jsonc
{} // без тела
```

**Ответ (JSON):**
```jsonc
[
  {
    "_id": "string",                    // ObjectId ассистента
    "name": "string",                   // название ассистента
    "description": "string",            // описание
    "modelId": "string",                // ID модели
    "preprompt": "string",              // системный промпт
    "tools": ["string"],                // подключённые инструменты
    "exampleInputs": ["string"],        // примеры запросов
    "avatar": "string",                 // хеш аватара
    "createdAt": "Date",                // дата создания
    "updatedAt": "Date",                // дата обновления
    "userCount": 42,                    // количество подписчиков
    "review": "PRIVATE|PENDING|APPROVED|DENIED", // статус модерации
    "rag": {                            // RAG-настройки
      "allowedLinks": ["string"],
      "allowedDomains": ["string"],
      "allowAllDomains": false
    },
    "generateSettings": {               // параметры генерации
      "temperature": 0.3,
      "top_p": 0.95,
      "repetition_penalty": 1.2,
      "top_k": 50
    },
    "createdById": "string",            // ID создателя (скрыт в ответе)
    "createdByMe": true                  // создан ли текущим пользователем
  }
]
```

**Логика:**
- Проверяет наличие сессии (`locals.user._id` или `locals.sessionId`).
- Получает настройки пользователя с подписками на ассистентов.
- Находит ассистентов из последних 300 диалогов пользователя.
- Объединяет подписанных ассистентов и ассистентов из диалогов.
- Фильтрует только тех, на которых пользователь подписан.
- Добавляет флаг `createdByMe` для каждого ассистента.

**Ошибки:**
- 401 - нет сессии/пользователя.

---

#### Админ-функции

##### 3. POST `/api/user/validate-token` - валидация админ-токена

**Запрос (JSON):**
```jsonc
{
  "token": "string"  // админ-токен для проверки
}
```

**Ответ (JSON):**
```jsonc
{
  "valid": true  // true если токен валидный, false если нет
}
```

**Логика:**
- Валидирует входные данные через Zod схему.
- Проверяет токен через `adminTokenManager.checkToken(token, sessionId)`.
- Возвращает результат валидации.

**Ошибки:**
- 400 - невалидное тело запроса (отсутствует или некорректный `token`).

---

#### Общие особенности

**Аутентификация:**
- Все ручки требуют авторизованного пользователя (`locals.user`).
- Сессия создаётся через OIDC callback при логине.

**Ограничения:**
- Нет ручек для обновления профиля пользователя.
- Изменения профиля происходят только через внешний OIDC провайдер.
- Админ-токены управляются отдельной системой (`adminTokenManager`).

**Данные пользователя:**
- Хранятся в коллекции `users` с полями: `_id`, `username`, `name`, `email`, `avatarUrl`, `hfUserId`, `createdAt`, `updatedAt`.
- Связаны с настройками через `userId` в коллекции `settings`.

### Аутентификация 

#### OIDC авторизация

##### 1. GET `/login` - авторизация через OIDC

**Запрос:**
- Параметры query (опционально):
  - `callback` - альтернативный redirect URI

**Ответ:**
- HTTP 302 редирект на OIDC провайдера

**Логика:**
- Получает `referer` из заголовков для определения базового URL.
- Формирует `redirectURI` по умолчанию: `${origin}${base}/login/callback`.
- Если передан `callback` и он в списке разрешённых (`ALTERNATIVE_REDIRECT_URLS`) - использует его.
- Генерирует authorization URL через `getOIDCAuthorizationUrl()` с CSRF-токеном.
- Редиректит пользователя на провайдера.

**Ошибки:**
- 500 - ошибка генерации authorization URL.

---

##### 2. GET `/login/callback?code=&state=&iss=` - обработка callback авторизации

**Параметры query:**
- `code` - authorization code от провайдера
- `state` - base64-encoded CSRF токен
- `iss` - issuer URL (опционально, для мульти-провайдеров)

**Ответ:**
- HTTP 302 редирект на главную страницу (`${base}/`)

**Логика:**
- Декодирует `state` из base64 и валидирует CSRF токен.
- Обменивает `code` на токены доступа через `getOIDCUserData()`.
- Получает данные пользователя (email, username, name, avatar).
- Применяет allow-лист:
  - Проверяет `ALLOWED_USER_EMAILS` (точные email).
  - Проверяет `ALLOWED_USER_DOMAINS` (домены email).
  - Требует верифицированный email.
- Создаёт или обновляет пользователя через `updateUser()`:
  - Сохраняет в коллекцию `users`.
  - Создаёт сессию в коллекции `sessions`.
  - Устанавливает HTTP-only cookie с `sessionId`.

**Ошибки:**
- 400 - ошибка OIDC (`error` параметр в query).
- 403 - невалидный CSRF токен или пользователь не в allow-листе.
- 500 - ошибка обмена токенов или сохранения пользователя.

---

#### Выход

##### 3. POST `/logout` - выход из системы

**Запрос:**
```jsonc
{} // без тела
```

**Ответ:**
- HTTP 302 редирект на главную страницу (`${base}/`)

**Логика:**
- Удаляет сессию из коллекции `sessions` по `sessionId`.
- Удаляет HTTP-only cookie:
  - `path: "/"`
  - `sameSite: "lax"` (dev) или `"none"` (prod)
  - `secure: true` (prod) или `false` (dev/insecure)
  - `httpOnly: true`

**Ошибки:**
- Нет специфических ошибок (всегда редирект).

---

### Администрирование 

#### Экспорт данных

##### 1. POST `/admin/export` - экспорт диалогов в Parquet

**Запрос (JSON):**
```jsonc
{
  "model": "string"  // модель для фильтрации диалогов
}
```

**Запрос (заголовки):**
```http
Authorization: Bearer <ADMIN_API_SECRET>
Content-Type: application/json
```

**Ответ:**
```jsonc
{} // 200 OK, пустое тело (асинхронная операция)
```

**Логика:**
- Проверяет наличие `PARQUET_EXPORT_DATASET` и `PARQUET_EXPORT_HF_TOKEN`.
- Валидирует `model` параметр.
- Создаёт Parquet схему с полями: `title`, `created_at`, `updated_at`, `messages[]`.
- Экспортирует диалоги в два потока:
  - Гостевые сессии (`sessionId` exists, `userId` не существует).
  - Авторизованные пользователи (`userId` exists).
- Фильтрует только диалоги с `shareConversationsWithModelAuthors: true`.
- Создаёт временный файл `/tmp/conversations-{date}-{timestamp}.parquet`.
- Загружает файл в Hugging Face Hub через `uploadFile()`.
- Удаляет временный файл.

**Ошибки:**
- 500 - не настроен экспорт (`PARQUET_EXPORT_*` переменные).
- 400 - невалидный `model`.

---

#### Статистика

##### 2. POST `/admin/stats/compute` - пересчёт статистики

**Запрос:**
```jsonc
{} // без тела
```

**Запрос (заголовки):**
```http
Authorization: Bearer <ADMIN_API_SECRET>
```

**Ответ (JSON):**
```jsonc
{
  "message": "Stats job started"
}
```
- HTTP 202 Accepted

**Логика:**
- Запускает асинхронный job `computeAllStats()`.
- Не ждёт завершения (fire-and-forget).
- Логирует ошибки в случае сбоя.

**Ошибки:**
- Нет специфических ошибок (job запускается асинхронно).

---

#### Общие особенности

**Безопасность:**
- OIDC callback защищён CSRF токенами.
- Allow-лист по email/доменам для контроля доступа.
- Админ-ручки требуют `ADMIN_API_SECRET` в заголовке `Authorization: Bearer`.

**Конфигурация:**
- `OPENID_CONFIG` - настройки OIDC провайдера.
- `ALLOWED_USER_EMAILS` - разрешённые email адреса.
- `ALLOWED_USER_DOMAINS` - разрешённые домены email.
- `ALTERNATIVE_REDIRECT_URLS` - альтернативные callback URL.
- `PARQUET_EXPORT_*` - настройки экспорта данных.

**Сессии:**
- Хранятся в коллекции `sessions` с полями: `sessionId`, `userId`, `createdAt`, `expiresAt`.
- Cookie настраивается в зависимости от окружения (dev/prod).

**Метрики:**
- Статистика включает подсчёт диалогов, сообщений, голосов по моделям.
- Экспорт данных для анализа качества моделей.

### Системные 

#### Здоровье

##### 1. GET `/healthcheck` - проверка здоровья системы

**Запрос:**
```jsonc
{} // без тела
```

**Ответ:**
```jsonc
"OK" // строка
```
- HTTP 200 OK

**Логика:**
- Простая проверка доступности сервиса.
- Возвращает статическую строку "OK".
- Используется для мониторинга и load balancer health checks.

**Ошибки:**
- Нет специфических ошибок (если сервис недоступен - соединение не установится).

---

#### Альтернативная API

##### 2. GET/POST/PUT/PATCH/DELETE `/api/v2/[...slugs]` - прокси для Elysia API

**Запрос:**
- Любой HTTP метод (GET, POST, PUT, PATCH, DELETE)
- Путь: `/api/v2/{любой_путь}`

**Ответ:**
- Зависит от обработчика Elysia API

**Логика:**
- Универсальный прокси для всех методов HTTP.
- Передаёт запрос в приложение Elysia через `app.handle(request)`.
- Используется для:
  - Расширений функциональности
  - Совместимости с внешними API
  - Альтернативных эндпоинтов
  - Интеграций с внешними сервисами

**Примеры использования:**
```jsonc
// Возможные пути (зависят от конфигурации Elysia):
GET /api/v2/models/info
POST /api/v2/webhooks/slack
PUT /api/v2/integrations/notion
PATCH /api/v2/settings/advanced
DELETE /api/v2/cache/clear
```

**Ошибки:**
- Зависят от конкретного обработчика Elysia.
- Обычно возвращаются как есть от Elysia приложения.

---

#### Общие особенности

**Архитектура:**
- Два слоя API: основной SvelteKit (`/api/*`) и расширяемый Elysia (`/api/v2/*`).
- Elysia используется для дополнительной функциональности без изменения основного кода.

**Мониторинг:**
- `/healthcheck` - простейшая проверка доступности.
- Можно расширить для проверки БД, внешних сервисов, дискового пространства.

**Расширяемость:**
- `/api/v2/*` позволяет добавлять новые эндпоинты без модификации SvelteKit роутов.
- Подходит для webhooks, интеграций, экспериментальных функций.

**Безопасность:**
- Elysia API может иметь собственную аутентификацию и авторизацию.
- Рекомендуется ограничить доступ к `/api/v2/*` если не нужен публичный доступ.

### Публичные страницы 

#### Главная и каталоги

##### 1. GET `/` - главная страница

**Запрос:**
```jsonc
{} // без тела
```

**Ответ:**
- HTML страница (SvelteKit SSR)

**Логика:**
- Главная страница приложения.
- Может содержать:
  - Форму создания нового диалога
  - Список последних диалогов пользователя
  - Рекомендуемые модели/ассистенты
  - Статистику использования

**Ошибки:**
- Стандартные HTTP ошибки (404, 500 и т.д.).

---

##### 2. GET `/assistants` - каталог ассистентов

**Запрос:**
- Query параметры (опционально):
  - `q` - поисковый запрос
  - `modelId` - фильтр по модели
  - `p` - номер страницы
  - `user` - фильтр по создателю
  - `showUnfeatured` - показать немодерированные (админ)

**Ответ:**
- HTML страница с каталогом ассистентов

**Логика:**
- Отображает каталог ассистентов с пагинацией.
- Поддерживает поиск и фильтрацию.
- Показывает только APPROVED ассистенты (если не админ).
- Включает карточки с аватарами, описаниями, счётчиками пользователей.

**Ошибки:**
- Стандартные HTTP ошибки.

---

##### 3. GET `/models` - каталог моделей

**Запрос:**
```jsonc
{} // без тела
```

**Ответ:**
- HTML страница с каталогом моделей

**Логика:**
- Отображает список доступных моделей.
- Показывает описания, возможности (multimodal, tools), ссылки на документацию.
- Исключает unlisted модели.

**Ошибки:**
- Стандартные HTTP ошибки.

---

##### 4. GET `/tools` - каталог инструментов

**Запрос:**
- Query параметры (опционально):
  - `q` - поисковый запрос

**Ответ:**
- HTML страница с каталогом инструментов

**Логика:**
- Отображает каталог инструментов (конфиговые + community APPROVED).
- Поддерживает поиск по названию/описанию.
- Показывает иконки, описания, примеры использования.

**Ошибки:**
- Стандартные HTTP ошибки.

---

#### Детальные страницы

##### 5. GET `/assistant/{id}` - страница ассистента

**Параметры пути:**
- `id` - ObjectId ассистента

**Ответ:**
- HTML страница с деталями ассистента

**Логика:**
- Отображает полную информацию об ассистенте:
  - Название, описание, аватар
  - Подключённую модель и инструменты
  - Примеры запросов
  - RAG-настройки
  - Статистику использования
  - Кнопки подписки/отписки
- Проверяет доступность ассистента (не удалён, APPROVED или создан пользователем).

**Ошибки:**
- 404 - ассистент не найден или недоступен.

---

##### 6. GET `/models/{model}` - страница модели

**Параметры пути:**
- `model` - ID модели

**Ответ:**
- HTML страница с деталями модели

**Логика:**
- Отображает информацию о модели:
  - Описание и возможности
  - Параметры генерации
  - Примеры промптов
  - Связанные ассистенты
  - Статистику использования
- Проверяет что модель не unlisted.

**Ошибки:**
- 404 - модель не найдена или скрыта.

---

##### 7. GET `/tools/{id}` - страница инструмента

**Параметры пути:**
- `id` - ID инструмента

**Ответ:**
- HTML страница с деталями инструмента

**Логика:**
- Отображает информацию об инструменте:
  - Название, описание, иконка
  - Параметры и примеры
  - Схему входных/выходных данных
  - Статистику использования
  - Связанные ассистенты
- Проверяет доступность (конфиговый или community APPROVED).

**Ошибки:**
- 404 - инструмент не найден или недоступен.

---

#### Настройки и политики

##### 8. GET `/settings` - настройки пользователя

**Запрос:**
```jsonc
{} // без тела
```

**Ответ:**
- HTML страница с настройками

**Логика:**
- Отображает форму настроек пользователя:
  - Активная модель
  - Подключённые инструменты
  - Настройки приватности (shareConversationsWithModelAuthors)
  - UI настройки (hideEmojiOnSidebar, disableStream, directPaste)
  - Кастомные промпты
- Требует авторизации.

**Ошибки:**
- 401 - пользователь не авторизован.

---

##### 9. GET `/privacy` - политика конфиденциальности

**Запрос:**
```jsonc
{} // без тела
```

**Ответ:**
- HTML страница с политикой конфиденциальности

**Логика:**
- Статическая страница с информацией о:
  - Сборе и использовании данных
  - Хранении диалогов
  - Передаче данных провайдерам моделей
  - Правах пользователей

**Ошибки:**
- Стандартные HTTP ошибки.

---

#### Публичный контент

##### 10. GET `/r/{id}` - публичный просмотр расшаренного диалога

**Параметры пути:**
- `id` - 7-символьный shareId

**Ответ:**
- HTML страница с диалогом

**Логика:**
- Отображает публичный слепок диалога:
  - Заголовок и сообщения
  - Информацию о модели/ассистенте
  - Возможность создать копию диалога
  - Кнопку "Начать новый чат с этой моделью"
- Не требует авторизации.
- Читает данные из коллекции `sharedConversations`.

**Ошибки:**
- 404 - расшаренный диалог не найден.

---

#### Общие особенности

**Рендеринг:**
- Все страницы используют SvelteKit SSR.
- Данные загружаются на сервере и передаются в компоненты.

**Авторизация:**
- Большинство страниц доступны без авторизации.
- `/settings` требует авторизации.
- Публичные страницы (`/r/{id}`) доступны всем.

**SEO и мета-теги:**
- Каждая страница может иметь уникальные мета-теги.
- Публичные страницы оптимизированы для социальных сетей.

**Навигация:**
- Единая навигация через layout компоненты.
- Breadcrumbs для каталогов и детальных страниц.

### Файлы и медиа

#### Аватары и превью

##### 1. GET `/assistant/{id}/avatar.jpg` - аватар ассистента

**Параметры пути:**
- `id` - ObjectId ассистента

**Ответ:**
- Бинарный поток изображения
- Заголовки:
```http
Content-Type: image/jpeg
Content-Disposition: inline; filename="avatar.jpg"
Cache-Control: public, max-age=31536000
```

**Логика:**
- Проверяет существование ассистента.
- Ищет файл в GridFS bucket по ключу `{assistantId}`.
- Возвращает JPEG изображение (512x512, качество 80%).
- Если аватара нет - возвращает дефолтное изображение или 404.

**Ошибки:**
- 404 - ассистент не найден или аватар отсутствует.

---

##### 2. GET `/assistant/{id}/thumbnail.png` - превью ассистента

**Параметры пути:**
- `id` - ObjectId ассистента

**Ответ:**
- Бинарный поток изображения
- Заголовки:
```http
Content-Type: image/png
Content-Disposition: inline; filename="thumbnail.png"
Cache-Control: public, max-age=31536000
```

**Логика:**
- Генерирует превью на основе данных ассистента:
  - Использует аватар если есть
  - Или создаёт превью с названием/иконкой ассистента
  - Размер обычно 256x256 или меньше
- Возвращает PNG изображение.

**Ошибки:**
- 404 - ассистент не найден.

---

##### 3. GET `/models/{model}/thumbnail.png` - превью модели

**Параметры пути:**
- `model` - ID модели

**Ответ:**
- Бинарный поток изображения
- Заголовки:
```http
Content-Type: image/png
Content-Disposition: inline; filename="thumbnail.png"
Cache-Control: public, max-age=31536000
```

**Логика:**
- Генерирует превью модели:
  - Использует `logoUrl` из конфигурации модели если есть
  - Или создаёт превью с названием модели и логотипом провайдера
  - Размер обычно 256x256 или меньше
- Возвращает PNG изображение.

**Ошибки:**
- 404 - модель не найдена или скрыта (unlisted).

---

#### Общие особенности

**Хранение файлов:**
- Используется MongoDB GridFS для хранения бинарных данных.
- Файлы именуются по ID сущности (ассистента/модели).
- Поддерживается версионирование (новые файлы заменяют старые).

**Обработка изображений:**
- Аватары обрабатываются через Sharp:
  - Ресайз до 512x512 с сохранением пропорций
  - Конвертация в JPEG с качеством 80%
  - Оптимизация размера файла

**Кэширование:**
- Все медиа-файлы имеют долгосрочное кэширование (1 год).
- Браузеры и CDN могут кэшировать изображения.
- При обновлении файла меняется его содержимое.

**Безопасность:**
- Проверка существования сущности перед отдачей файла.
- Нет прямого доступа к файловой системе.
- Все файлы проходят через GridFS с контролем доступа.

**Формат файлов:**
- Аватары: JPEG (лучше для фотографий).
- Превью: PNG (лучше для логотипов и графики).
- Поддержка прозрачности в PNG превью.

**Fallback:**
- Если файл отсутствует - возвращается дефолтное изображение.
- Дефолтные изображения хранятся в `static/` папке.
- Graceful degradation для отсутствующих медиа.

### Конфигурация

#### Пользовательские настройки

##### 1. POST `/settings/(nav)/+server.ts` - обновление настроек пользователя

**Запрос (JSON):**
```jsonc
{
  "shareConversationsWithModelAuthors": true,  // опционально: делиться диалогами с авторами моделей
  "hideEmojiOnSidebar": false,                // опционально: скрыть эмодзи в боковой панели
  "activeModel": "string",                    // опционально: ID активной модели
  "customPrompts": {                          // опционально: кастомные промпты
    "modelId1": "string",                    // промпт для конкретной модели
    "modelId2": "string"
  },
  "tools": ["string"],                        // опционально: список ID подключённых инструментов
  "disableStream": false,                     // опционально: отключить стриминг ответов
  "directPaste": false                        // опционально: прямой вставка без форматирования
}
```

**Ответ:**
```jsonc
{} // 200 OK, пустое тело
```

**Логика:**
- Валидирует входные данные через Zod схему.
- Проверяет существование всех указанных инструментов:
  - Ищет в коллекции `tools` (community tools)
  - Ищет в `toolFromConfigs` (конфиговые инструменты)
  - Фильтрует только существующие инструменты
- Обновляет настройки пользователя в коллекции `settings`:
  - `$set` - обновляет переданные поля
  - `$setOnInsert` - устанавливает `createdAt` при создании
  - `upsert: true` - создаёт настройки если их нет
- Если передан `ethicsModalAccepted: true` - устанавливает `ethicsModalAcceptedAt: new Date()`.

**Валидация полей:**
```jsonc
{
  "shareConversationsWithModelAuthors": "boolean (default: false)",
  "hideEmojiOnSidebar": "boolean (default: false)", 
  "activeModel": "string (default: defaultModel.id)",
  "customPrompts": "record<string, string> (default: {})",
  "tools": "string[] (default: undefined)",
  "disableStream": "boolean (default: false)",
  "directPaste": "boolean (default: false)"
}
```

**Ошибки:**
- 400 - невалидные данные (несоответствие схеме Zod).
- 401 - пользователь не авторизован.

---

#### Общие особенности

**Структура настроек:**
- Хранятся в коллекции `settings` с полями:
  - `userId` или `sessionId` (для гостей)
  - `assistants` - массив подписанных ассистентов
  - `activeModel` - текущая активная модель
  - `customPrompts` - промпты для конкретных моделей
  - `tools` - подключённые инструменты
  - `shareConversationsWithModelAuthors` - согласие на передачу данных
  - `hideEmojiOnSidebar` - UI настройки
  - `disableStream` - настройки генерации
  - `directPaste` - настройки ввода
  - `ethicsModalAcceptedAt` - время принятия этических правил

**Безопасность:**
- Все изменения привязаны к текущему пользователю/сессии.
- Невозможно изменить настройки другого пользователя.
- Валидация всех входных данных.

**Совместимость:**
- Поддержка как авторизованных пользователей, так и гостевых сессий.
- Настройки сохраняются отдельно для каждого пользователя/сессии.

**Инструменты:**
- Автоматическая фильтрация несуществующих инструментов.
- Поддержка как community tools, так и конфиговых инструментов.
- При удалении инструмента он автоматически убирается из всех настроек.
